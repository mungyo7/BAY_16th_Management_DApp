# BAY Point 마켓플레이스 스마트 컨트랙트 가이드

## 📌 개요

BAY Point 마켓플레이스는 Solana 블록체인 위에서 동작하는 탈중앙화 마켓플레이스입니다. 사용자들은 BAY Point 토큰을 사용하여 상품을 구매할 수 있으며, 관리자는 상품을 등록하고 관리할 수 있습니다.

## 🏗️ 컨트랙트 구조

### 1. **핵심 구성 요소**

#### 📦 **State (상태 저장소)**
컨트랙트에서 사용되는 데이터 구조들을 정의합니다.

- **MarketplaceState**: 마켓플레이스의 전체적인 상태를 저장
  - `admin`: 관리자 지갑 주소
  - `token_mint`: 사용할 토큰(BAY Point)의 주소
  - `treasury`: 판매 수익금이 모이는 금고 계정
  - `product_count`: 등록된 상품의 총 개수
  - `total_sales`: 총 판매액
  - `is_initialized`: 초기화 여부
  - `bump`: PDA(Program Derived Address) 생성용 시드

- **Product**: 개별 상품 정보
  - `id`: 상품 고유 번호
  - `name`: 상품명 (최대 64자)
  - `description`: 상품 설명 (최대 256자)
  - `price`: 가격 (BAY Point 단위)
  - `stock`: 재고 수량
  - `sold_count`: 판매된 수량
  - `is_active`: 활성화 상태
  - `seller`: 판매자 주소
  - `created_at/updated_at`: 생성/수정 시간

- **Purchase**: 구매 기록
  - `id`: 구매 고유 번호
  - `product_id`: 구매한 상품 번호
  - `buyer`: 구매자 지갑 주소
  - `quantity`: 구매 수량
  - `total_price`: 총 구매 금액
  - `timestamp`: 구매 시간

## 🔧 주요 기능 (Instructions)

### 1. **initialize_marketplace** - 마켓플레이스 초기화

**역할**: 마켓플레이스를 처음 설정할 때 한 번만 실행됩니다.

**작동 원리**:
1. 관리자가 이 함수를 호출하여 마켓플레이스를 초기화
2. 관리자 주소, 토큰 주소, 금고 계정을 설정
3. 상품 카운터와 총 판매액을 0으로 초기화

**필요한 계정들**:
- `admin`: 관리자 (서명 필요)
- `marketplace`: 생성될 마켓플레이스 계정
- `token_mint`: BAY Point 토큰 계정
- `treasury`: 금고 계정 (자동 생성)

**초보자 이해하기**:
> 가게를 처음 열 때 가게 주인을 정하고, 어떤 화폐를 쓸지 정하고, 금고를 만드는 것과 같습니다.

---

### 2. **add_product** - 상품 등록

**역할**: 관리자가 새로운 상품을 마켓플레이스에 등록합니다.

**작동 원리**:
1. 관리자만 실행 가능 (권한 체크)
2. 상품명, 설명, 가격, 재고 수량을 입력
3. 새로운 상품 계정 생성 및 정보 저장
4. 상품 ID는 자동으로 부여됨

**매개변수**:
- `name`: 상품명
- `description`: 상품 설명
- `price`: 가격 (0보다 커야 함)
- `stock`: 재고 수량 (0보다 커야 함)

**초보자 이해하기**:
> 가게 주인이 새로운 상품을 진열대에 올리는 것과 같습니다. 상품 이름표를 붙이고, 가격표를 달고, 재고 수량을 기록합니다.

---

### 3. **update_product** - 상품 정보 수정

**역할**: 기존 상품의 가격이나 재고를 수정합니다.

**작동 원리**:
1. 관리자만 실행 가능
2. 활성화된 상품만 수정 가능
3. 가격과 재고 중 원하는 것만 선택적으로 수정 가능
4. 수정 시간 자동 기록

**매개변수**:
- `price`: 새로운 가격 (선택적)
- `stock`: 새로운 재고 수량 (선택적)

**초보자 이해하기**:
> 가게 주인이 상품의 가격표를 바꾸거나 재고를 추가로 채워넣는 것과 같습니다.

---

### 4. **deactivate_product** - 상품 비활성화

**역할**: 상품 판매를 중단합니다.

**작동 원리**:
1. 관리자만 실행 가능
2. 상품의 `is_active` 상태를 false로 변경
3. 비활성화된 상품은 구매 불가능

**초보자 이해하기**:
> 가게에서 특정 상품을 진열대에서 내리는 것과 같습니다. 상품은 여전히 존재하지만 더 이상 판매하지 않습니다.

---

### 5. **purchase_product** - 상품 구매

**역할**: 사용자가 상품을 구매합니다.

**작동 원리**:
1. 구매하려는 상품이 활성화 상태인지 확인
2. 재고가 충분한지 확인
3. 구매자의 토큰 잔액이 충분한지 확인
4. 토큰을 구매자 계정에서 금고로 전송
5. 재고 차감 및 판매 수량 증가
6. 구매 기록 생성

**매개변수**:
- `product_id`: 구매할 상품 번호
- `quantity`: 구매 수량

**필요한 계정들**:
- `buyer`: 구매자 (서명 필요)
- `buyer_token_account`: 구매자의 토큰 계정
- `treasury`: 금고 계정
- `product`: 상품 계정

**초보자 이해하기**:
> 손님이 상품을 고르고, 돈을 지불하면 가게 금고에 돈이 들어가고, 재고가 줄어들며, 영수증이 발행되는 과정입니다.

## 🛡️ 보안 기능

### 권한 관리
- **관리자 전용 기능**: 상품 등록, 수정, 비활성화는 오직 관리자만 가능
- **권한 검증**: 모든 중요한 작업 전에 권한을 확인

### 오버플로우 방지
- **안전한 연산**: 모든 숫자 계산에서 오버플로우 체크
- **에러 처리**: 문제 발생 시 즉시 트랜잭션 중단

### 데이터 검증
- **입력값 검증**: 가격과 재고는 0보다 커야 함
- **길이 제한**: 상품명과 설명의 최대 길이 제한
- **상태 확인**: 비활성화된 상품은 구매 불가

## 🔑 PDA (Program Derived Address) 구조

PDA는 프로그램이 관리하는 특별한 계정 주소입니다.

### 시드(Seed) 구조
- **마켓플레이스**: `[b"marketplace"]`
- **상품**: `[b"product", marketplace_key, product_id]`
- **구매 기록**: `[b"purchase", buyer_key, purchase_id]`
- **금고**: `[b"treasury", marketplace_key]`

**초보자 이해하기**:
> PDA는 프로그램이 직접 관리하는 특별한 보관함입니다. 각 보관함은 고유한 주소를 가지며, 프로그램만이 열 수 있습니다.

## 📊 에러 처리

컨트랙트는 다양한 상황에 대한 에러 메시지를 제공합니다:

- `Unauthorized`: 권한이 없는 사용자가 관리자 기능 시도
- `AlreadyInitialized`: 이미 초기화된 마켓플레이스를 다시 초기화 시도
- `ProductNotActive`: 비활성화된 상품 구매 시도
- `InsufficientStock`: 재고보다 많은 수량 구매 시도
- `InsufficientBalance`: 잔액 부족으로 구매 불가
- `InvalidPrice`: 잘못된 가격 설정 (0 이하)
- `InvalidQuantity`: 잘못된 수량 입력

## 💡 사용 시나리오

### 시나리오 1: 마켓플레이스 설정
1. 관리자가 `initialize_marketplace` 실행
2. BAY Point 토큰과 금고 설정 완료
3. 마켓플레이스 운영 준비 완료

### 시나리오 2: 상품 판매 과정
1. 관리자가 `add_product`로 "NFT 아트" 상품 등록 (가격: 100 BAY, 재고: 10개)
2. 사용자 A가 `purchase_product`로 2개 구매
3. 100 × 2 = 200 BAY가 금고로 이동
4. 재고가 8개로 감소
5. 구매 기록 생성

### 시나리오 3: 재고 관리
1. 재고가 부족해지면 관리자가 `update_product`로 재고 추가
2. 시즌 세일을 위해 가격 할인
3. 판매 종료 시 `deactivate_product`로 비활성화

## 🚀 시작하기

### 필요한 도구
- Solana CLI
- Anchor Framework
- Node.js & npm
- BAY Point 토큰

### 배포 과정
1. 컨트랙트 빌드: `anchor build`
2. 테스트 실행: `anchor test`
3. 배포: `anchor deploy`
4. 초기화: `initialize_marketplace` 실행

## 📝 주의사항

1. **관리자 권한**: 관리자 키는 안전하게 보관해야 합니다
2. **토큰 설정**: 올바른 BAY Point 토큰 주소를 사용해야 합니다
3. **가격 단위**: 모든 가격은 토큰의 최소 단위로 설정됩니다
4. **트랜잭션 비용**: 모든 작업에는 SOL 가스비가 필요합니다

## 🤝 도움말

이 마켓플레이스는 Anchor 프레임워크를 사용하여 개발되었으며, Solana 블록체인의 보안과 속도를 활용합니다. 추가 질문이나 도움이 필요하시면 개발팀에 문의해주세요.

---

*이 문서는 초보자도 이해할 수 있도록 작성되었습니다. 기술적인 세부사항이 필요하신 경우 소스 코드를 직접 참고해주세요.*